# Agents Documentation

В этом документе описаны основные агенты (компоненты-сервисы) системы animemov-bot, их роли и взаимодействие.

## Обзор архитектуры

Бот построен на основе чистой архитектуры с разделением на слои и использует паттерн "агентов" - специализированных сервисов, каждый из которых отвечает за конкретную область ответственности.

## Основные агенты

### 1. TwitterMediaDownloader
**Расположение:** `src/slices/publish-post/infrastructure/twitter-media-downloader.ts`

**Назначение:** Агент для загрузки медиа-файлов из Twitter/X

**Ключевые функции:**
- Извлечение медиа-файлов из твитов по URL
- Поддержка различных типов медиа (изображения, видео)
- Работа через HTTPS-прокси для обхода ограничений
- Сохранение файлов во временное хранилище

**Зависимости:**
- `twitter-api-v2` для работы с Twitter API
- `TempFileManager` для управления временными файлами
- HTTPS-прокси для доступа к Twitter API

### 2. TelegramChannelPublisher
**Расположение:** `src/slices/publish-post/infrastructure/telegram-channel-publisher.ts`

**Назначение:** Агент для публикации контента в Telegram каналы

**Ключевые функции:**
- Публикация медиа-файлов в указанный Telegram канал
- Поддержка групповой отправки медиа (media groups)
- Добавление подписей и ссылок на исходные твиты
- Обработка различных типов медиа-контента

**Зависимости:**
- Grammy Bot API для взаимодействия с Telegram
- Временные файлы от `TempFileManager`

### 3. TelegramUserNotifier
**Расположение:** `src/slices/publish-post/infrastructure/telegram-user-notifier.ts`

**Назначение:** Агент для уведомления пользователей о статусе операций

**Ключевые функции:**
- Отправка уведомлений пользователям о статусе обработки
- Информирование об ошибках и ограничениях (rate limits)
- Отправка сообщений о успешной публикации

**Зависимости:**
- Grammy Bot API для отправки сообщений пользователям

### 4. PublishPostQueue
**Расположение:** `src/slices/publish-post/infrastructure/publish-post-queue.ts`

**Назначение:** Агент для управления очередью публикаций

**Ключевые функции:**
- Управление очередью запросов на публикацию
- Предотвращение дублирования публикаций
- Обработка rate limits и повторных попыток
- Персистентное хранение состояния очереди

**Зависимости:**
- Локальная база данных для хранения состояния очереди

### 5. TempFileManager
**Расположение:** `src/shared/storage/temp-file-manager.ts`

**Назначение:** Агент для управления временными файлами

**Ключевые функции:**
- Создание и управление временными файлами
- Автоматическая очистка устаревших файлов
- Безопасное хранение загруженных медиа-файлов
- Предоставление путей к файлам для других агентов

## Взаимодействие агентов

### Основной поток обработки:

1. **Пользователь** отправляет команду `/post` с URL твита
2. **TelegramHandler** принимает команду и инициирует `PublishPostUseCase`
3. **PublishPostQueue** проверяет, не обрабатывается ли уже этот твит
4. **TwitterMediaDownloader** загружает медиа-файлы из твита
5. **TelegramChannelPublisher** публикует медиа в целевой канал
6. **TelegramUserNotifier** уведомляет пользователя о результате
7. **TempFileManager** очищает временные файлы

### Диаграмма взаимодействия:

```
User Input → TelegramHandler → PublishPostUseCase
                                      ↓
                              PublishPostQueue
                                      ↓
                           TwitterMediaDownloader
                                      ↓
                            TempFileManager ← → Files
                                      ↓
                          TelegramChannelPublisher
                                      ↓
                           TelegramUserNotifier → User
```

## Конфигурация агентов

Каждый агент настраивается через переменные окружения:

- **TwitterMediaDownloader**: `TWITTER_*` переменные для API доступа и прокси
- **TelegramChannelPublisher**: `TELEGRAM_TARGET_CHANNEL_ID` для целевого канала
- **TelegramUserNotifier**: `TELEGRAM_BOT_TOKEN` для отправки уведомлений
- **PublishPostQueue**: `QUEUE_DB_PATH` для пути к базе данных очереди
- **TempFileManager**: `TEMP_DIR` для каталога временных файлов

## Обработка ошибок

Каждый агент реализует собственную логику обработки ошибок:

- **Rate Limits**: Автоматические повторные попытки с экспоненциальной задержкой
- **Network Errors**: Retry-логика с ограниченным количеством попыток
- **API Errors**: Информативные сообщения пользователям через TelegramUserNotifier
- **File System Errors**: Graceful fallback и очистка ресурсов

## Расширение системы

Для добавления новых агентов рекомендуется:

1. Создать новый файл в соответствующем слое (`infrastructure`, `application`, `domain`)
2. Реализовать интерфейс соответствующего слоя
3. Добавить внедрение зависимостей в `main.ts`
4. Обновить `PublishPostUseCase` для интеграции нового агента
5. Добавить необходимые переменные окружения
6. Обновить данную документацию

## Мониторинг и логирование

Все агенты используют централизованную систему логирования через `shared/logging/logger.ts`, что обеспечивает:

- Структурированное логирование в JSON формате
- Трассировку операций между агентами
- Мониторинг производительности и ошибок
- Удобную отладку в процессе разработки

## Тестирование агентов

Каждый агент должен покрываться unit-тестами с мокированием внешних зависимостей:

- **TwitterMediaDownloader**: Мокирование Twitter API и файловой системы
- **TelegramChannelPublisher**: Мокирование Telegram Bot API
- **PublishPostQueue**: Тестирование с временной базой данных
- **TempFileManager**: Тестирование операций с файловой системой

Для интеграционных тестов рекомендуется использовать тестовые окружения с реальными, но изолированными сервисами.